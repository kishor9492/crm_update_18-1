{% extends 'crm/base.html' %}

{% block content %}
<style>
    /* Page-specific overrides only */
    main {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    }

    /* Stats Cards - Additional styling */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--color-surface), #f8fafc);
        border-radius: var(--radius-md);
        padding: 25px;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--color-primary);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--color-primary);
        line-height: 1;
    }

    /* Status Badges - Additional colors */
    .status-connected-recent {
        background: rgba(72, 187, 120, 0.15);
        color: var(--color-success);
        border: 1px solid rgba(72, 187, 120, 0.3);
    }

    .status-connected-old {
        background: rgba(237, 137, 54, 0.15);
        color: var(--color-warning);
        border: 1px solid rgba(237, 137, 54, 0.3);
    }

    .status-never-connected {
        background: rgba(229, 62, 62, 0.15);
        color: var(--color-danger);
        border: 1px solid rgba(229, 62, 62, 0.3);
    }

    /* Table Action Buttons - Additional colors */
    .add-meeting {
        background: linear-gradient(135deg, var(--color-info), #3182ce);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .add-sales {
        background: linear-gradient(135deg, var(--color-success), #38a169);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .add-call {
        background: linear-gradient(135deg, var(--color-accent), #3a9a9a);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .view-calls {
        background: linear-gradient(135deg, #805ad5, #6b46c1);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .add-redemption {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
    }
</style>

<div class="container">
    <div class="page-header">
        <h2>ğŸ‘¥ Client Management</h2>
        <p>Manage and track all your client relationships</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value">{{ total_clients|default:"0" }}</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--color-success);">
            <div class="stat-label">Active This Month</div>
            <div class="stat-value" style="color: var(--color-success);">{{ active_clients|default:"0" }}</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--color-danger);">
            <div class="stat-label">Never Connected</div>
            <div class="stat-value" style="color: var(--color-danger);">{{ never_connected|default:"0" }}</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--color-info);">
            <div class="stat-label">Relationship Managers</div>
            <div class="stat-value" style="color: var(--color-info);">{{ total_rms|default:"0" }}</div>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="filter-card">
        <div class="filter-title">Search & Filter Clients</div>
        <form method="get" action="" class="filter-form">
            <div class="form-group">
                <label for="search">Search</label>
                <input type="text" name="search" id="search" placeholder="Name or PAN..." value="{{ search_query }}">
            </div>

            {% if user.is_superuser %}
            <div class="form-group">
                <label for="rm_id">RM</label>
                <select name="rm_id" id="rm_id">
                    <option value="">All RMs</option>
                    {% for rm in relationship_managers %}
                    <option value="{{ rm.id }}" {% if rm.id|stringformat:"s" == selected_rm_id %} selected {% endif %}> {{ rm.get_full_name|default:rm.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="all" {% if selected_status == 'all' %} selected {% endif %}>All Status</option>
                    <option value="Connected (within 30 days)" {% if selected_status == 'Connected (within 30 days)' %} selected {% endif %} > Connected (Recent)</option>
                    <option value="Connected (over 30 days ago)" {% if selected_status == 'Connected (over 30 days ago)' %} selected {% endif %} >C onnected (Old)</option>
                    <option value="Never Connected" {% if selected_status == 'Never Connected' %} selected {% endif %}>Never Connected</option>
                </select>
            </div>

            <div class="form-group">
                <button type="submit">ğŸ” Search</button>
            </div>
        </form>
    </div>

    <!-- Action Buttons -->
    {% if request.user.is_superuser %}
    <div class="action-buttons" style="justify-content: center; margin-bottom: 25px;">
        <a href="{% url 'add_client' %}" class="action-btn btn-primary">
            <span>â•</span>
            <span>Add Client</span>
        </a>
        <form method="get" action="{% url 'export_clients_csv' %}" style="display: inline;">
            {% if search_query %}
            <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            {% if selected_rm_id %}
            <input type="hidden" name="rm_id" value="{{ selected_rm_id }}">
            {% endif %}
            {% if selected_status %}
            <input type="hidden" name="status" value="{{ selected_status }}">
            {% endif %}
            <button type="submit" class="action-btn btn-export">
                <span>ğŸ’¾</span>
                <span>Export CSV</span>
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Clients Table -->
    <div class="table-card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Contact Info</th>
                        <th>PAN</th>
                        <th>RM</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client, status in page_obj %}
                    <tr>
                        <td style="font-weight: 600;">{{ client.name }}</td>
                        <td>
                            <div style="margin-bottom: 4px;">ğŸ“§ {{ client.email }}</div>
                            <div>ğŸ“ {{ client.phone|floatformat:0 }}</div>
                        </td>
                        <td><code
                                style="background: var(--color-background); padding: 4px 8px; border-radiusus: 4px;">{{ client.pan }}</code>
                        </td>
                        <td>
                            {% if client.relationship_manager %}
                            {{ client.relationship_manager.get_full_name }}
                            {% else %}
                            <em style="color: var(--color-text-secondary);">Not Assigned</em>
                            {% endif %}
                        </td>
                        <td>
                            {% if status == "Connected (within 30 days)" %}
                            <span class="badge status-connected-recent">
                                âœ… {{ status }}
                            </span>
                            {% elif status == "Connected (over 30 days ago)" %}
                            <span class="badge status-connected-old">
                                â° {{ status }}
                            </span>
                            {% else %}
                            <span class="badge status-never-connected">
                                âŒ {{ status }}
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="table-actions" style="display: flex; flex-wrap: wrap; gap: 4px;">
                                <a href="{% url 'add_meeting' client.id %}" class="btn-action add-meeting">ğŸ“…
                                    Meeting</a>
                                <a href="{% url 'add_sales' client.id %}" class="btn-action add-sales">ğŸ’° Sales</a>
                                <a href="{% url 'add_redemption' client.id %}" class="btn-action add-redemption">â–
                                    Redemption</a>
                                <a href="{% url 'add_call' client.id %}" class="btn-action add-call">ğŸ“ Call</a>
                                <a href="{% url 'client_calls' client.id %}" class="btn-action view-calls">ğŸ‘ï¸ View</a>
                                <a href="{% url 'update_client' client.id %}" class="btn-action btn-update">âœï¸ Edit</a>
                                {% if request.user.is_superuser %}
                                <a href="{% url 'delete_client' client.id %}" class="btn-action btn-delete"
                                    onclick="return confirm('Are you sure?')">ğŸ—‘ï¸ Delete</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ”</div>
                                <h3 style="color: var(--color-text); margin-bottom: 10px;">No clients found</h3>
                                <p>Try adjusting your search criteria or add a new client</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a
            href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_rm_id %}&rm_id={{ selected_rm_id }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">First</a>
        <a
            href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_rm_id %}&rm_id={{ selected_rm_id }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Previous</a>
        {% else %}
        <span class="disabled">First</span>
        <span class="disabled">Previous</span>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a
            href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_rm_id %}&rm_id={{ selected_rm_id }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Next</a>
        <a
            href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_rm_id %}&rm_id={{ selected_rm_id }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Last</a>
        {% else %}
        <span class="disabled">Next</span>
        <span class="disabled">Last</span>
        {% endif %}
    </div>
</div>
{% endblock %}