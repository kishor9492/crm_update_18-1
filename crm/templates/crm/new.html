{% extends 'crm/base.html' %}

{% block content %}
<style>
    /* Page-specific overrides only */
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    main {
        padding: 20px !important;
    }

    /* Stats Grid - Page specific */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--color-surface), #f8fafc);
        border-radius: var(--radius-md);
        padding: 25px;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--color-primary);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--color-primary);
        line-height: 1;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .chart-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 25px;
    }

    .chart-container .card-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 15px;
        border-bottom: 3px solid rgba(75, 193, 193, 0.1);
    }

    .chart-container .card-title::before {
        content: '';
        width: 4px;
        height: 24px;
        background: linear-gradient(135deg, var(--color-primary), #667eea);
        border-radius: 2px;
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 60px;
        color: var(--color-text-secondary);
    }

    .loading::after {
        content: '';
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-border);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-top: 15px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Total Row Styling */
    tbody tr:last-child {
        font-weight: 700;
        background: linear-gradient(90deg, rgba(75, 193, 193, 0.05), rgba(75, 193, 193, 0.15));
        border-top: 2px solid var(--color-primary);
    }

    tbody tr:last-child td {
        color: var(--color-primary);
        font-weight: 700;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        main {
            padding: 10px !important;
        }

        .charts-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container">
    <!-- Header -->
    <div class="page-header">
        <h2>ðŸ“Š Admin Dashboard</h2>
        <p>Monitor your team's performance and track key metrics</p>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <div class="filter-title">Filter Dashboard Data</div>
        <form method="GET" action="" class="filter-form">
            <div class="form-group">
                <label for="relationship_manager">RM</label>
                <select name="relationship_manager_id" id="relationship_manager">
                    <option value="">All Managers</option>
                    {% for manager in relationship_managers %}
                        <option value="{{ manager.id }}" {% if manager.id|stringformat:"s" == selected_manager_id %}selected{% endif %}>
                            {{ manager.first_name }} {{ manager.last_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input type="date" name="start_date" id="start_date">
            </div>

            <div class="form-group">
                <label for="end_date">End Date</label>
                <input type="date" name="end_date" id="end_date">
            </div>

            <div class="form-group">
                <button type="submit">Apply Filters</button>
            </div>
        </form>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
        <!-- Will be populated dynamically -->
    </div>

    <!-- Product-wise Sales Table -->
    <div class="card">
        <h3 class="card-title" style="font-size: 1.3rem; font-weight: 700; color: var(--color-text); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; padding-bottom: 15px; border-bottom: 3px solid rgba(75, 193, 193, 0.1);">
            <span style="width: 4px; height: 24px; background: linear-gradient(135deg, var(--color-primary), #667eea); border-radius: 2px;"></span>
            ðŸ“ˆ Product-wise Sales by Relationship Manager
        </h3>
        <div class="table-container">
            <table id="salesTable">
                <thead>
                    <tr>
                        <th>Manager</th>
                        <th>Meetings</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="2" class="loading">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="card-title">ðŸ‘¥ Meetings by Manager</div>
            <canvas id="meetingsChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="card-title">ðŸ’° Sales Performance</div>
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- BDM Performance Section -->
    <div id="bdmSection" style="display: none;">
        <!-- BDM Performance Table -->
        <div class="card">
            <h3 class="card-title" style="font-size: 1.3rem; font-weight: 700; color: var(--color-text); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; padding-bottom: 15px; border-bottom: 3px solid rgba(75, 193, 193, 0.1);">
                <span style="width: 4px; height: 24px; background: linear-gradient(135deg, var(--color-primary), #667eea); border-radius: 2px;"></span>
                ðŸŽ¯ BDM Performance Overview
            </h3>
            <div class="table-container">
                <table id="bdmPerformanceTable">
                    <thead>
                        <tr>
                            <th>BDM Name</th>
                            <th>Open Leads</th>
                            <th>Closed Leads</th>
                            <th>Total Leads</th>
                            <th>Conversion Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="loading">Loading BDM data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BDM Performance Chart -->
        <div class="chart-container">
            <div class="card-title">ðŸ“Š BDM Performance Metrics</div>
            <canvas id="bdmPerformanceChart"></canvas>
        </div>
    </div>
</div>

<script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedManagerId = urlParams.get('relationship_manager_id') || '';
    const startDate = urlParams.get('start_date') || '';
    const endDate = urlParams.get('end_date') || '';

    // Set form values
    if (selectedManagerId) document.getElementById('relationship_manager').value = selectedManagerId;
    if (startDate) document.getElementById('start_date').value = startDate;
    if (endDate) document.getElementById('end_date').value = endDate;

    // Build API URL
    const apiUrl = `/dashboard/?ajax=1` +
        (selectedManagerId ? `&relationship_manager_id=${selectedManagerId}` : '') +
        (startDate ? `&start_date=${startDate}` : '') +
        (endDate ? `&end_date=${endDate}` : '');

    // Chart instances
    let meetingsChartInstance = null;
    let salesChartInstance = null;
    let bdmChartInstance = null;

    // Fetch and render dashboard data
    fetch(apiUrl, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        const salesData = data.sales_data || [];
        const meetingsSummary = data.meetings_data.summary || [];
        const productSales = data.product_sales_per_manager || [];
        const bdmData = data.bdm_performance || [];

        renderStats(meetingsSummary, productSales);
        renderSalesTable(productSales, meetingsSummary);
        renderMeetingsChart(meetingsSummary);
        renderSalesChart(salesData);

        if (bdmData.length > 0) {
            document.getElementById('bdmSection').style.display = 'block';
            renderBDMTable(bdmData);
            renderBDMChart(bdmData);
        }
    })
    .catch(error => {
        console.error('Error fetching dashboard data:', error);
        document.querySelector('#salesTable tbody').innerHTML = '<tr><td colspan="2" style="text-align: center; color: #e53e3e; padding: 30px;">Error loading data. Please try again.</td></tr>';
    });

    function renderStats(meetingsSummary, productSales) {
        const statsGrid = document.getElementById('statsGrid');
        const totalMeetings = meetingsSummary.reduce((sum, item) => sum + (item.total_meetings || 0), 0);
        const totalSales = productSales.reduce((sum, item) => sum + Number(item.total_sales || 0), 0);
        const totalManagers = meetingsSummary.length;
        const avgMeetings = totalManagers ? Math.round(totalMeetings / totalManagers) : 0;

        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Meetings</div>
                <div class="stat-value">${totalMeetings.toLocaleString()}</div>
            </div>
            <div class="stat-card" style="border-left-color: #667eea;">
                <div class="stat-label">Total Sales</div>
                <div class="stat-value" style="color: #667eea;">â‚¹${totalSales.toLocaleString()}</div>
            </div>
            <div class="stat-card" style="border-left-color: #48bb78;">
                <div class="stat-label">Active Managers</div>
                <div class="stat-value" style="color: #48bb78;">${totalManagers}</div>
            </div>
            <div class="stat-card" style="border-left-color: #ed8936;">
                <div class="stat-label">Avg Meetings/Manager</div>
                <div class="stat-value" style="color: #ed8936;">${avgMeetings}</div>
            </div>
        `;
    }

    function renderSalesTable(productSales, meetingsSummary) {
        const tableBody = document.querySelector('#salesTable tbody');
        const tableHead = document.querySelector('#salesTable thead tr');
        tableBody.innerHTML = '';

        const productSet = new Set();
        productSales.forEach(item => productSet.add(item.product));
        const products = Array.from(productSet).sort();

        let headerRow = '<th>Manager</th><th>Meetings</th>';
        products.forEach(product => headerRow += `<th>${product}</th>`);
        tableHead.innerHTML = headerRow;

        const managers = {};
        const totals = {};
        let totalMeetings = 0;
        products.forEach(p => totals[p] = 0);

        productSales.forEach(item => {
            const name = `${item.relationship_manager__first_name} ${item.relationship_manager__last_name}`;
            if (!managers[name]) managers[name] = { sales: {}, meetings: 0 };
            managers[name].sales[item.product] = (managers[name].sales[item.product] || 0) + Number(item.total_sales);
        });

        meetingsSummary.forEach(item => {
            const name = `${item.relationship_manager__first_name} ${item.relationship_manager__last_name}`;
            if (!managers[name]) managers[name] = { sales: {}, meetings: 0 };
            managers[name].meetings = item.total_meetings;
        });

        for (const [manager, data] of Object.entries(managers)) {
            const row = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.textContent = manager;
            nameCell.style.fontWeight = '600';
            row.appendChild(nameCell);

            const meetingCell = document.createElement('td');
            meetingCell.textContent = data.meetings || 0;
            totalMeetings += data.meetings || 0;
            row.appendChild(meetingCell);

            products.forEach(product => {
                const sales = data.sales[product] || 0;
                totals[product] += sales;
                const cell = document.createElement('td');
                cell.textContent = 'â‚¹' + sales.toLocaleString();
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        }

        const totalRow = document.createElement('tr');
        const totalLabelCell = document.createElement('td');
        totalLabelCell.textContent = 'TOTAL';
        totalRow.appendChild(totalLabelCell);

        const totalMeetingCell = document.createElement('td');
        totalMeetingCell.textContent = totalMeetings.toLocaleString();
        totalRow.appendChild(totalMeetingCell);

        products.forEach(product => {
            const totalsCell = document.createElement('td');
            totalsCell.textContent = 'â‚¹' + totals[product].toLocaleString();
            totalRow.appendChild(totalsCell);
        });

        tableBody.appendChild(totalRow);
    }

    function renderMeetingsChart(meetingsSummary) {
        if (meetingsChartInstance) meetingsChartInstance.destroy();
        const labels = meetingsSummary.map(item => `${item.relationship_manager__first_name} ${item.relationship_manager__last_name}`);
        const values = meetingsSummary.map(item => item.total_meetings);

        const ctx = document.getElementById('meetingsChart').getContext('2d');
        meetingsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Total Meetings',
                    data: values,
                    backgroundColor: 'rgba(75, 193, 193, 0.8)',
                    borderColor: 'rgba(75, 193, 193, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderSalesChart(salesData) {
        if (salesChartInstance) salesChartInstance.destroy();
        const managerSales = {};
        salesData.forEach(sale => {
            const name = `${sale.relationship_manager__first_name} ${sale.relationship_manager__last_name}`;
            managerSales[name] = (managerSales[name] || 0) + Number(sale.total_sales || 0);
        });

        const labels = Object.keys(managerSales);
        const values = Object.values(managerSales);

        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)', 'rgba(75, 193, 193, 0.8)', 'rgba(72, 187, 120, 0.8)',
                        'rgba(237, 137, 54, 0.8)', 'rgba(245, 101, 101, 0.8)', 'rgba(159, 122, 234, 0.8)',
                    ],
                    borderWidth: 3,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        callbacks: { label: (ctx) => ctx.label + ': â‚¹' + ctx.parsed.toLocaleString() }
                    }
                }
            }
        });
    }

    function renderBDMTable(bdmData) {
        const tableBody = document.querySelector('#bdmPerformanceTable tbody');
        const tableHead = document.querySelector('#bdmPerformanceTable thead tr');
        tableBody.innerHTML = '';

        const productSet = new Set();
        bdmData.forEach(bdm => {
            if (bdm.sales_by_product) Object.keys(bdm.sales_by_product).forEach(p => productSet.add(p));
        });
        const products = Array.from(productSet).sort();

        tableHead.innerHTML = `
            <th>BDM Name</th><th>Open Leads</th><th>Closed Leads</th><th>Total Leads</th>
            ${products.map(p => `<th>${p}</th>`).join('')}<th>Conversion Rate</th>
        `;

        bdmData.forEach(bdm => {
            const row = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.textContent = bdm.name;
            nameCell.style.fontWeight = '600';
            row.appendChild(nameCell);

            ['open_leads', 'closed_leads'].forEach(key => {
                const cell = document.createElement('td');
                cell.textContent = bdm[key] || 0;
                row.appendChild(cell);
            });

            const totalLeads = (bdm.open_leads || 0) + (bdm.closed_leads || 0);
            const totalCell = document.createElement('td');
            totalCell.textContent = totalLeads;
            totalCell.style.fontWeight = '600';
            row.appendChild(totalCell);

            products.forEach(product => {
                const salesCell = document.createElement('td');
                salesCell.textContent = bdm.sales_by_product?.[product] || 0;
                row.appendChild(salesCell);
            });

            const conversionCell = document.createElement('td');
            const rate = totalLeads ? ((bdm.closed_leads / totalLeads) * 100).toFixed(1) : '0';
            conversionCell.innerHTML = `<span class="badge">${rate}%</span>`;
            row.appendChild(conversionCell);

            tableBody.appendChild(row);
        });
    }

    function renderBDMChart(bdmData) {
        if (bdmChartInstance) bdmChartInstance.destroy();
        const bdmNames = bdmData.map(bdm => bdm.name);
        const openLeadsData = bdmData.map(bdm => bdm.open_leads || 0);
        const closedLeadsData = bdmData.map(bdm => bdm.closed_leads || 0);
        const conversionRates = bdmData.map(bdm => {
            const total = (bdm.open_leads || 0) + (bdm.closed_leads || 0);
            return total ? parseFloat(((bdm.closed_leads / total) * 100).toFixed(2)) : 0;
        });

        const ctx = document.getElementById('bdmPerformanceChart').getContext('2d');
        bdmChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: bdmNames,
                datasets: [
                    { label: 'Open Leads', data: openLeadsData, backgroundColor: 'rgba(237, 137, 54, 0.8)', borderRadius: 6 },
                    { label: 'Closed Leads', data: closedLeadsData, backgroundColor: 'rgba(72, 187, 120, 0.8)', borderRadius: 6 },
                    {
                        label: 'Conversion Rate (%)', data: conversionRates, type: 'line', yAxisID: 'y1',
                        backgroundColor: 'rgba(102, 126, 234, 0.8)', borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 3, tension: 0.4, pointRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top', labels: { padding: 15 } } },
                scales: {
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Lead Count' }, beginAtZero: true },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Conversion Rate (%)' }, beginAtZero: true, max: 100, grid: { drawOnChartArea: false } }
                }
            }
        });
    }
</script>
{% endblock %}
